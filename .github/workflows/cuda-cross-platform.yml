name: cuda-cross-platform

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
    paths:
      - "csrc/**"
      - "scripts/**"
      - "python/iir2d_jax/**"
      - "CMakeLists.txt"
      - ".github/workflows/cuda-cross-platform.yml"
  pull_request:
    paths:
      - "csrc/**"
      - "scripts/**"
      - "python/iir2d_jax/**"
      - "CMakeLists.txt"
      - ".github/workflows/cuda-cross-platform.yml"

jobs:
  enforce_self_hosted_cuda_policy:
    runs-on: ubuntu-latest
    steps:
      - name: Require self-hosted CUDA mode
        shell: bash
        run: |
          if [ "${{ vars.IIR2D_USE_SELF_HOSTED }}" != "true" ]; then
            echo "IIR2D_USE_SELF_HOSTED must be set to true for this workflow."
            echo "CUDA parity and GPU E2E smoke are required on every push/PR."
            exit 1
          fi

  linux_cuda_build_smoke:
    needs: enforce_self_hosted_cuda_policy
    runs-on: [self-hosted, linux, x64, gpu, cuda]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build and smoke (Linux)
        shell: bash
        run: |
          bash scripts/build_and_smoke_wsl.sh

      - name: Core benchmark smoke (Linux)
        shell: bash
        run: |
          python3 scripts/benchmark_core_cuda.py \
            --sizes 512x512 \
            --filter_ids 1 \
            --border_modes mirror \
            --precisions f32 \
            --warmup 3 \
            --iters 8 \
            --out_csv /tmp/iir2d_core_bench_smoke.csv

      - name: CUDA-vs-CPU parity matrix (Linux)
        shell: bash
        run: |
          python3 scripts/validate_cuda_cpu_matrix.py \
            --sizes 63x47 \
            --filter_ids 1,2,3,4,5,6,7,8 \
            --border_modes clamp,mirror,wrap,constant \
            --precisions f32,mixed,f64 \
            --border_const 0.125

      - name: Video pipeline GPU E2E smoke (Linux)
        shell: bash
        run: |
          set -euo pipefail
          command -v ffmpeg >/dev/null 2>&1 || { echo "ffmpeg missing from PATH"; exit 1; }
          command -v ffprobe >/dev/null 2>&1 || { echo "ffprobe missing from PATH"; exit 1; }

          ffmpeg -hide_banner -loglevel error -y \
            -f lavfi -i "testsrc2=duration=4:size=640x360:rate=30" \
            -c:v libx264 -pix_fmt yuv420p /tmp/iir2d_video_smoke_input.mp4

          python3 scripts/video_demo_cuda_pipeline.py \
            --in_video /tmp/iir2d_video_smoke_input.mp4 \
            --out_video /tmp/iir2d_video_smoke_output.mp4 \
            --filter_id 4 \
            --border_mode mirror \
            --precision f32 \
            --temporal_ema_alpha 0.95 \
            --codec libx264 \
            --preset medium \
            --crf 18

          python3 scripts/benchmark_video_cuda_pipeline.py \
            --in_video /tmp/iir2d_video_smoke_input.mp4 \
            --out_csv /tmp/iir2d_video_bench_smoke.csv \
            --filter_id 4 \
            --border_mode mirror \
            --precision f32 \
            --mode full \
            --codec libx264 \
            --encode_sink null \
            --warmup_frames 8 \
            --timed_frames 32 \
            --report_every 0

      - name: Upload benchmark artifact (Linux)
        uses: actions/upload-artifact@v4
        with:
          name: linux-core-benchmark-smoke
          path: /tmp/iir2d_core_bench_smoke.csv

      - name: Upload video benchmark artifacts (Linux)
        uses: actions/upload-artifact@v4
        with:
          name: linux-video-benchmark-smoke
          path: |
            /tmp/iir2d_video_smoke_input.mp4
            /tmp/iir2d_video_smoke_output.mp4
            /tmp/iir2d_video_bench_smoke.csv

  windows_cuda_build_smoke:
    needs: enforce_self_hosted_cuda_policy
    runs-on: [self-hosted, windows, x64, gpu, cuda]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build and smoke (Windows, status-only)
        shell: pwsh
        run: |
          powershell -ExecutionPolicy Bypass -File .\scripts\build_and_smoke_windows.ps1 -SkipGpuSmoke
