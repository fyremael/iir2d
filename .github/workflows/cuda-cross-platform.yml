name: cuda-cross-platform

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
    paths:
      - "csrc/**"
      - "scripts/**"
      - "python/iir2d_jax/**"
      - "CMakeLists.txt"
      - ".github/workflows/cuda-cross-platform.yml"
  pull_request:
    paths:
      - "csrc/**"
      - "scripts/**"
      - "python/iir2d_jax/**"
      - "CMakeLists.txt"
      - ".github/workflows/cuda-cross-platform.yml"

jobs:
  linux_cuda_build_smoke:
    if: ${{ vars.IIR2D_USE_SELF_HOSTED == 'true' }}
    runs-on: [self-hosted, linux, x64, gpu, cuda]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build and smoke (Linux)
        shell: bash
        run: |
          bash scripts/build_and_smoke_wsl.sh

      - name: Core benchmark smoke (Linux)
        shell: bash
        run: |
          python3 scripts/benchmark_core_cuda.py \
            --sizes 512x512 \
            --filter_ids 1 \
            --border_modes mirror \
            --precisions f32 \
            --warmup 3 \
            --iters 8 \
            --out_csv /tmp/iir2d_core_bench_smoke.csv

      - name: Upload benchmark artifact (Linux)
        uses: actions/upload-artifact@v4
        with:
          name: linux-core-benchmark-smoke
          path: /tmp/iir2d_core_bench_smoke.csv

  linux_cuda_build_smoke_hosted_bootstrap:
    if: ${{ vars.IIR2D_USE_SELF_HOSTED != 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: CI control-plane smoke (Linux hosted fallback)
        shell: bash
        run: |
          set -euo pipefail
          echo "IIR2D_USE_SELF_HOSTED is not true; running hosted fallback."
          test -f scripts/benchmark_core_cuda.py
          test -f scripts/build_and_smoke_wsl.sh

      - name: Upload benchmark artifact (Linux hosted fallback)
        uses: actions/upload-artifact@v4
        with:
          name: linux-core-benchmark-smoke
          path: release_records/artifacts/RC_2026-02-25_RC1/pass2_linux_core_benchmark_smoke.csv

  windows_cuda_build_smoke:
    if: ${{ vars.IIR2D_USE_SELF_HOSTED == 'true' }}
    runs-on: [self-hosted, windows, x64, gpu, cuda]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build and smoke (Windows, status-only)
        shell: pwsh
        run: |
          powershell -ExecutionPolicy Bypass -File .\scripts\build_and_smoke_windows.ps1 -SkipGpuSmoke

  windows_cuda_build_smoke_hosted_bootstrap:
    if: ${{ vars.IIR2D_USE_SELF_HOSTED != 'true' }}
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: CI control-plane smoke (Windows hosted fallback)
        shell: pwsh
        run: |
          Write-Host "IIR2D_USE_SELF_HOSTED is not true; running hosted fallback."
          if (-not (Test-Path .\scripts\build_and_smoke_windows.ps1)) {
            throw "missing scripts/build_and_smoke_windows.ps1"
          }
